<!DOCTYPE html>
<html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <title>一个 printf 引发的基础复习 &mdash; 刘华健</title>
    <link rel="stylesheet" href="/assets/vendor/primer-css/css/primer.css">
    <link rel="stylesheet" href="/assets/vendor/primer-markdown/dist/user-content.min.css">
    <link rel="stylesheet" href="/assets/vendor/octicons/octicons/octicons.css">
    <link rel="stylesheet" href="/assets/css/components/collection.css">
    <link rel="stylesheet" href="/assets/css/components/repo-card.css">
    <link rel="stylesheet" href="/assets/css/sections/repo-list.css">
    <link rel="stylesheet" href="/assets/css/sections/mini-repo-list.css">
    <link rel="stylesheet" href="/assets/css/components/boxed-group.css">
    <link rel="stylesheet" href="/assets/css/globals/common.css">
    <link rel="stylesheet" href="/assets/vendor/share.js/dist/css/share.min.css">
    <link rel="stylesheet" href="/assets/css/globals/responsive.css">
    <link rel="stylesheet" href="/assets/css/posts/index.css">
    <!-- Latest compiled and minified CSS -->
    

    
    <link rel="alternate" type="application/atom+xml" title="刘华健" href="/feed.xml">
    <link rel="shortcut icon" href="/favicon.ico">
    
    <meta property="og:title" content="一个 printf 引发的基础复习">
      
    <meta name="keywords" content="printf, IEEE 表示法">
    <meta name="og:keywords" content="printf, IEEE 表示法">
      
    <meta name="description" content="先看一下引发我追究一下 printf 和栈桢等相关知识的一段简单的程序：">
    <meta name="og:description" content="先看一下引发我追究一下 printf 和栈桢等相关知识的一段简单的程序：">
      
    
    
        
    
    <meta property="og:url" content="http://www.lhjzzu.com/2015/01/19/printf/">
    <meta property="og:site_name" content="刘华健">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="zh_CN" />
    
    <meta property="article:published_time" content="2015-01-19">
    
    <script src="/assets/vendor/jquery/dist/jquery.min.js"></script>
    <script src="/assets/js/jquery-ui.js"></script>
</head>
<body class="" data-mz="">
    <header class="site-header">
        <div class="container">
            <h1><a href="/" title="刘华健"><span class="octicon octicon-mark-github"></span> 刘华健</a></h1>
            <nav class="site-header-nav" role="navigation">
                
                <a href="/" class=" site-header-nav-item" target="" title="首页">首页</a>
                
                <a href="/categories/" class=" site-header-nav-item" target="" title="分类">分类</a>
                
                <a href="/links/" class=" site-header-nav-item" target="" title="链接">链接</a>
                
                <a href="/about/" class=" site-header-nav-item" target="" title="关于">关于</a>
                
            </nav>
        </div>
    </header>
    <!-- / header -->

    <section class="collection-head small geopattern" data-pattern-id="一个 printf 引发的基础">
<div class="container">
  <div class="columns">
    <div class="column three-fourths">
      <div class="collection-title">
        <h1 class="collection-header">一个 printf 引发的基础复习</h1>
        <div class="collection-info">
          
          <span class="meta-info">
            <span class="octicon octicon-calendar"></span> 2015/01/19
          </span>
          
          
          <span class="meta-info">
            <span class="octicon octicon-file-directory"></span>
            <a href="/categories/#CPlusPlus" title="CPlusPlus">CPlusPlus</a>
          </span>
          
        </div>
      </div>
    </div>
  </div>
</div>
</section>
<!-- / .banner -->
<section class="container content">
<div class="columns">
  <div class="column three-fourths" >
    <article class="article-content markdown-body">
    <p>先看一下引发我追究一下 printf 和栈桢等相关知识的一段简单的程序：</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%d "</span><span class="p">,</span> <span class="mf">8.0</span><span class="o">/</span><span class="mi">5</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%.2f"</span><span class="p">,</span> <span class="mi">8</span><span class="o">/</span><span class="mi">5</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>初看时，想当然了一下觉得输出就是<code class="highlighter-rouge">1 1.00</code>，后来编译出来运行一下，屏幕上却赫然是<code class="highlighter-rouge">-1717986918 1.60</code>。</p>

<p>在脑中干想了良久，其时的疑惑主要有两点：</p>

<ol>
  <li>
    <p>1.6 转换为整形怎么就变成了负数。</p>
  </li>
  <li>
    <p>1 转换为浮点数怎么就变成了 1.60。</p>
  </li>
</ol>

<p>现在看来当时的理解中存在着一个很大的误区，就是觉得 printf 是将参数根据格式化字符串进行强制类型转换之后再进行输出的，即编译器会自动将程序变换成如下模样：</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%d "</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="mf">8.0</span><span class="o">/</span><span class="mi">5</span><span class="p">));</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%.2f"</span><span class="p">,</span> <span class="p">(</span><span class="kt">float</span><span class="p">)(</span><span class="mi">8</span><span class="o">/</span><span class="mi">5</span><span class="p">));</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>但是第一段程序的输出已经打脸了，那么想想办法找找合理的解释。</p>

<h3 id="section">分析</h3>

<p>面对这类问题，现象诡异程序简单，能想到的最有效的方法之一就是看汇编。</p>

<p>使用<code class="highlighter-rouge">g++ -S</code>编译出第一段程序的汇编如下：</p>

<pre><code class="language-asm">	.file	"demo.cpp"
	.def	___main;	.scl	2;	.type	32;	.endef
	.section .rdata,"dr"
LC1:
	.ascii "%d \0"
LC2:
	.ascii "%.2f\0"
	.text
	.globl	_main
	.def	_main;	.scl	2;	.type	32;	.endef
_main:
	pushl	%ebp
	movl	%esp, %ebp
	andl	$-16, %esp
	subl	$16, %esp
	call	___main
	fldl	LC0
	fstpl	4(%esp)
	movl	$LC1, (%esp)
	call	_printf
	movl	$1, 4(%esp)
	movl	$LC2, (%esp)
	call	_printf
	movl	$0, %eax
	leave
	ret
	.section .rdata,"dr"
	.align 8
LC0:
	.long	-1717986918
	.long	1073322393
	.ident	"GCC: (GNU) 4.9.1"
	.def	_printf;	.scl	2;	.type	32;	.endef
</code></pre>

<h4 id="printf-">第一个 printf 结果的解释</h4>

<p>一眼望去，有没有发现一个熟悉的数？没错，我们程序的第一个输出 -1717986918 赫然在目。由此产生的猜想：</p>

<p><strong>LC0 对应的两个。long 合起来是 double 类型的 8.0/5，而对其低位 4 字节进行截取后对应的整数为 -1717986918。</strong></p>

<p>来把相关的数转换成二进制验证一下（IEEE 浮点数表示法相关知识见<a href="#ieee-754">附：IEEE 754 浮点数表示法</a>）：</p>

<p>-1717986918 转换成十六进制为 -0x66666666，对应的二进制为：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>1110 0110 0110 0110 0110 0110 0110
</code></pre>
</div>

<p>因为负数在内存中使用补码存储，故将如上二进制转换为补码才是它在内存中的样子：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>1001 1001 1001 1001 1001 1001 1010
</code></pre>
</div>

<p>1073322393 转换成十六进制为 0x3ff99999，对应的二进制为：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>0011 1111 1111 1001 1001 1001 1001
</code></pre>
</div>

<p>将这两个数合起来，1073322393 作为高位就是：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>0011 1111 1111 1001 1001 1001 1001 1001 1001 1001 1001 1001 1001 1001 1010
</code></pre>
</div>

<p>转换成浮点数恰恰就是 1.6000000000000001，可以认为与 8.0/5 的结果相符。所以第一个 printf 输出结果的推论：</p>

<ol>
  <li>
    <p>给 printf 传递的是参数的原始类型，而不是根据格式化字符串进行强制转换后的类型。</p>

    <p>比如<code class="highlighter-rouge">printf("%d ", 8.0/5);</code>就会传 double 类型的 8.0/5，而不是根据 %d 强制转换成整型后再传参。</p>
  </li>
  <li>
    <p>printf 在根据格式化字符串组成输出的时候，会直接在对应参数的起始地址读取一个格式指定的类型出来。</p>

    <p>比如<code class="highlighter-rouge">printf("%d ", 8.0/5);</code>就会在 double 类型的 8.0/5 的位置读取一个整型数出来，而小端模式下是高位高地址，低位低地址，所以这里是将 double 的低位 4 字节按 int 类型读取。</p>

    <div class="highlighter-rouge"><pre class="highlight"><code>+--------------+
|  double low  | --&gt; 把低位 4 字节当作 int 读取
+--------------+
|  double high |
+--------------+
</code></pre>
    </div>
  </li>
</ol>

<h4 id="printf--1">第二次 printf 结果的解释</h4>

<p>在上面的汇编代码中对第二次 printf 的调用部分如下：</p>

<pre><code class="language-asm">	movl	$1, 4(%esp)
	movl	$LC2, (%esp)
	call	_printf
</code></pre>

<p>可以看到传参确实传的整数 1 进去的，但是输出就变成了 1.60，结合我们对第一个输出的推论，则是会在整型 1 的位置读取一个 double 类型的数，并将内存中的整型 1 作为 double 的低位部分。为什么这里偏偏这么巧会是 1.60 而不是其它的什么值呢？结合上一次调用 printf 时传的参是 8.0/5 的情况，猜想：</p>

<p><strong>受上一次调用后栈上残留数据的影响。</strong></p>

<p>即：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>+--------------+
|     int      | -+----&gt; 把这 8 字节当 double 读取
+--------------+  |
|residual data | -+
+--------------+
</code></pre>
</div>

<p>于是将第一次调用的传参修改一下将残留数据变化一下，即：</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%d "</span><span class="p">,</span> <span class="mi">9</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="mi">5</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%.2f"</span><span class="p">,</span> <span class="mi">8</span><span class="o">/</span><span class="mi">5</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>果然如预料第二个 printf 的输出变成了 1.80。这又一次印证了对第一个输出分析后的两个结论。来复习一下基础，引自《深入理解计算机系统》里的一段话：</p>

<blockquote>
  <p>假设过程 P（调用者）调用过程 Q（被调用者），则 Q 的参数放在 P 的栈帧中。</p>
</blockquote>

<p>即 printf 的参数是放在 main 函数的栈帧中的，那么两次调用<code class="highlighter-rouge">call _printf</code>前的堆栈情况应该是这样的：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>+-------------+                    +-------------+
|             |        ...         |             |
+-------------+                    +-------------+
|             |                    |             |
+-------------+                    +-------------+
| format str1 | &lt;-- esp            | format str2 | &lt;-- esp
+-------------+                    +-------------+
| double low  |                    |     int     |
+-------------+                    +-------------+
| double high |                    | double high |
+-------------+  main stack frame  +-------------+
|     ...     |                    |     ...     |
+-------------+                    +-------------+
|             |                    |             |
+-------------+                    +-------------+
|   (%ebp)    | &lt;-- ebp            |   (%ebp)    | &lt;-- ebp
+-------------+                    +-------------+
</code></pre>
</div>

<p>这里面补充的关键知识点：</p>

<ul>
  <li>被调用函数的参数存放在调用函数的栈帧中。</li>
</ul>

<h3 id="ieee-754">IEEE-754</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>+---+-----+----------+
| S | Exp | Mantissa |
+---+-----+----------+
</code></pre>
</div>

<p>S：符号位</p>

<p>Exp：指数偏差</p>

<p>Mantissa：尾数</p>

<ul>
  <li>
    <p>单精度（32 位）</p>

    <p>S：1 位</p>

    <p>Exp：8 位，二进制科学计数法中的指数加 127（2^(8-1)-1）</p>

    <p>Mantissa：23 位，二进制科学计数法中的小数部分</p>
  </li>
  <li>
    <p>双精度（64 位）</p>

    <p>S：1 位</p>

    <p>Exp：11 位，二进制科学计数法中的指数加 1023（2^(11-1)-1）</p>

    <p>Mantissa：52 位，二进制科学计数法中的小数部分</p>
  </li>
</ul>

    </article>
    <div class="share">
      <div class="share-component"></div>
    </div>
    <div class="comment">
      
  
      
      <!-- Duoshuo Comment BEGIN -->
      <!-- 多说评论框 BEGIN -->
      <div class="ds-thread" data-thread-key="/2015/01/19/printf/" data-title="一个 printf 引发的基础复习" data-url="http://www.lhjzzu.com/2015/01/19/printf/"></div>
      <!-- 多说评论框 END -->
      <!-- 多说公共JS代码 BEGIN (一个网页只需插入一次) -->
      <script type="text/javascript">
      var duoshuoQuery = {short_name:"abc19911991"};
        (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0]
           || document.getElementsByTagName('body')[0]).appendChild(ds);
        })();
        </script>
      <!-- 多说公共JS代码 END -->
      <!-- Duoshuo Comment END -->
      
    


    </div>
  </div>
  <div class="column one-fourth">
    
<h3>Search</h3>
<form action="get" id="site_search">
    <input type="text" id="search_box" placeholder="Search">
    <button class="btn btn-default" type="submit"><span class="octicon octicon-search"></span></button>
</form>

<ul id="search_results"></ul>

<link rel="stylesheet" type="text/css" href="/assets/css/modules/sidebar-search.css">
<script src="/assets/js/lunr.min.js"></script>
<script src="/assets/js/search.js"></script>


    
<h3>Post Directory</h3>
<div id="post-directory-module" class="mobile-hidden">
  <section class="post-directory">
  <!-- Links that trigger the jumping -->
  <!-- Added by javascript below -->
  <dl></dl>
  </section>
</div>

<script src="/assets/js/jquery.toc.js"></script>

  </div>
</div>
</section>
<!-- /section.content -->

    <footer class="container">
        <div class="site-footer" role="contentinfo">
            <div class="copyright left mobile-block">
                    © 2015
                    <span title="Liu Hua Jian">Liu Hua Jian</span>
                    <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a>
            </div>

            <ul class="site-footer-links right mobile-hidden">
                <li>
                    <a href="javascript:window.scrollTo(0,0)" >TOP</a>
                </li>
            </ul>
            <a href="https://github.com/lhjzzu/lhjzzu.github.io" target="_blank" aria-label="view source code">
                <span class="mega-octicon octicon-mark-github" title="GitHub"></span>
            </a>
            <ul class="site-footer-links mobile-hidden">
                
                <li>
                    <a href="/" title="首页" target="">首页</a>
                </li>
                
                <li>
                    <a href="/categories/" title="分类" target="">分类</a>
                </li>
                
                <li>
                    <a href="/links/" title="链接" target="">链接</a>
                </li>
                
                <li>
                    <a href="/about/" title="关于" target="">关于</a>
                </li>
                
                <li><a href="/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li>
            </ul>
        </div>
    </footer>
    <!-- / footer -->
    <script src="/assets/vendor/s.js/dist/js/share.min.js"></script>
    <script src="/assets/js/geopattern.js"></script>
    <script src="/assets/js/prism.js"></script>
    <link rel="stylesheet" href="/assets/css/globals/prism.css">
    <script>
      jQuery(document).ready(function($) {
        // geopattern
        $('.geopattern').each(function(){
          $(this).geopattern($(this).data('pattern-id'));
        });
       // hljs.initHighlightingOnLoad();
      });
    </script>
    
</body>
</html>
