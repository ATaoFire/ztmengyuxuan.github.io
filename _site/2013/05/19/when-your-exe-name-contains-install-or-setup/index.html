<!DOCTYPE html>
<html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <title>可执行文件名中包含 install 或 setup &mdash; 刘华健</title>
    <link rel="stylesheet" href="/assets/vendor/primer-css/css/primer.css">
    <link rel="stylesheet" href="/assets/vendor/primer-markdown/dist/user-content.min.css">
    <link rel="stylesheet" href="/assets/vendor/octicons/octicons/octicons.css">
    <link rel="stylesheet" href="/assets/css/components/collection.css">
    <link rel="stylesheet" href="/assets/css/components/repo-card.css">
    <link rel="stylesheet" href="/assets/css/sections/repo-list.css">
    <link rel="stylesheet" href="/assets/css/sections/mini-repo-list.css">
    <link rel="stylesheet" href="/assets/css/components/boxed-group.css">
    <link rel="stylesheet" href="/assets/css/globals/common.css">
    <link rel="stylesheet" href="/assets/vendor/share.js/dist/css/share.min.css">
    <link rel="stylesheet" href="/assets/css/globals/responsive.css">
    <link rel="stylesheet" href="/assets/css/posts/index.css">
    <!-- Latest compiled and minified CSS -->
    

    
    <link rel="alternate" type="application/atom+xml" title="刘华健" href="/feed.xml">
    <link rel="shortcut icon" href="/favicon.ico">
    
    <meta property="og:title" content="可执行文件名中包含 install 或 setup">
      
    <meta name="keywords" content="EXE, Windows">
    <meta name="og:keywords" content="EXE, Windows">
      
    <meta name="description" content="问题描述">
    <meta name="og:description" content="问题描述">
      
    
    
        
    
    <meta property="og:url" content="https://ztmengyuxuan.github.io/2013/05/19/when-your-exe-name-contains-install-or-setup/">
    <meta property="og:site_name" content="刘华健">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="zh_CN" />
    
    <meta property="article:published_time" content="2013-05-19">
    
    <script src="/assets/vendor/jquery/dist/jquery.min.js"></script>
    <script src="/assets/js/jquery-ui.js"></script>
</head>
<body class="" data-mz="">
    <header class="site-header">
        <div class="container">
            <h1><a href="/" title="刘华健"><span class="octicon octicon-mark-github"></span> 刘华健</a></h1>
            <nav class="site-header-nav" role="navigation">
                
                <a href="/" class=" site-header-nav-item" target="" title="首页">首页</a>
                
                <a href="/categories/" class=" site-header-nav-item" target="" title="分类">分类</a>
                
                <a href="/links/" class=" site-header-nav-item" target="" title="链接">链接</a>
                
                <a href="/about/" class=" site-header-nav-item" target="" title="关于">关于</a>
                
            </nav>
        </div>
    </header>
    <!-- / header -->

    <section class="collection-head small geopattern" data-pattern-id="可执行文件名中包含 insta">
<div class="container">
  <div class="columns">
    <div class="column three-fourths">
      <div class="collection-title">
        <h1 class="collection-header">可执行文件名中包含 install 或 setup</h1>
        <div class="collection-info">
          
          <span class="meta-info">
            <span class="octicon octicon-calendar"></span> 2013/05/19
          </span>
          
          
          <span class="meta-info">
            <span class="octicon octicon-file-directory"></span>
            <a href="/categories/#Windows" title="Windows">Windows</a>
          </span>
          
        </div>
      </div>
    </div>
  </div>
</div>
</section>
<!-- / .banner -->
<section class="container content">
<div class="columns">
  <div class="column three-fourths" >
    <article class="article-content markdown-body">
    <h3 id="section">问题描述</h3>

<p>在 Windows Vista+ 系统下，若 EXE 文件名中包含有「install」、「update」或「setup」等字样，可能出现如下问题：</p>

<ol>
  <li>
    <p>每次软件运行完退出后会弹出「程序兼容性助手」（Program Compatibility Assistant, 简称 PCA），提示软件未正确安装。</p>

    <p><img src="/images/posts/windows/pca.png" alt="" /></p>
  </li>
  <li>
    <p>在 Vista+ 的操作系统下任务栏右键该程序缺少「将此程序锁定到任务栏」和软件名同名项。</p>

    <table>
      <thead>
        <tr>
          <th>程序名</th>
          <th>运行时任务栏右键</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>a.exe</td>
          <td><img src="/images/posts/windows/a.png" alt="" /></td>
        </tr>
        <tr>
          <td>setup.exe</td>
          <td><img src="/images/posts/windows/setup.png" alt="" /></td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>你的程序没打算要求管理员权限的，但是运行的时候却弹 UAC 了。</p>

    <p>完全相同的两个 EXE 文件，名字不一样：</p>

    <p><img src="/images/posts/windows/name.png" alt="" /></p>
  </li>
</ol>

<h3 id="section-1">问题分析</h3>

<p>简而言之，上述现象发生的原因是 Windows Vista+ 系统的「安装程序检测」机制认为文件名中包含「install」、「update」或「setup」等字样，且没有在 Manifest 文件中显式指定 requestedExecutionLevel 的 32 位可执行程序是安装包，会主动为安装包弹出 UAC 提权申请，而「程序兼容性助手」会监控安装包的执行情况，如果它没有在「添加或删除程序」中创建一个条目，那「程序兼容性助手」会认为该安装包没有成功完成，在安装包结束后即弹出「程序兼容性助手」提示用户该程序可能安装不正确。</p>

<p>MSDN 关于「程序兼容性助手」的相关问答：</p>

<blockquote>
  <ol>
    <li>
      <p>What is the detection logic, and how does PCA know that the setup failed due to version problems?</p>

      <p>PCA does not specifically look for the setup’s failing due to version problems. The logic used by PCA is to detect if a setup did not complete successfully. It monitors a program detected as setup by Windows Vista and Windows Server 2008 and checks whether the program registers an entry in Add or Remove Programs (ARP). If no entries are created in ARP, PCA concludes that the installer did not complete successfully. It will then wait for the install program to terminate before displaying the UI. If it is an uninstaller, the detection looks for whether an entry was deleted from ARP.</p>
    </li>
    <li>
      <p>How does PCA get information about the setup programs?</p>

      <p>PCA relies on the User Account Control (UAC) feature in Windows Vista and Windows Server 2008 to know whether a program is a setup program. UAC includes detection for setup programs and will make sure the detected setup programs will be run as Administrator, which includes getting administrative credentials or confirmation from the user before launching the program.</p>
    </li>
  </ol>
</blockquote>

<p>原文链接：<a href="https://msdn.microsoft.com/zh-cn/bb756937">Application Compatibility: Program Compatibility Assistant (PCA)</a></p>

<p>MSDN 关于「安装程序检测」的相关介绍：</p>

<blockquote>
  <p>Installer Detection only applies to:</p>

  <ul>
    <li>32 bit executables</li>
    <li>Applications without a requestedExecutionLevel</li>
    <li>Interactive processes running as a Standard User with UAC enabled</li>
  </ul>

  <p>Before a 32 bit process is created, the following attributes are checked to determine whether it is an installer:</p>

  <ul>
    <li>Filename includes keywords like “install,” “setup,” “update,” etc.</li>
    <li>Keywords in the following Versioning Resource fields: Vendor, Company Name, Product Name, File Description, Original Filename, Internal Name, and Export Name</li>
    <li>Keywords in the side-by-side application manifest embedded in the executable</li>
    <li>Keywords in specific StringTable entries linked in the executable</li>
    <li>Key attributes in the resource file data linked in the executable</li>
    <li>Targeted sequences of bytes within the executable</li>
  </ul>
</blockquote>

<p>原文链接：<a href="https://msdn.microsoft.com/EN-US/library/bb756960(v=VS.10,d=hv.2).aspx">New UAC Technologies for Windows Vista</a></p>

<p>另外，微软的一个 PPT 介绍了「安装程序检测」和它可能产生的误判，以及解决的办法，给出的方案是内嵌 Manifest 或者外置一个名为「MyApp.exe.manifest」的文件：</p>

<ul>
  <li><a href="https://www.google.com.hk/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=2&amp;ved=0CCUQFjABahUKEwiPmdW8rYjJAhVHG5QKHQwjBzY&amp;url=%68%74%74%70%3a%2f%2f%64%6f%77%6e%6c%6f%61%64%2e%6d%69%63%72%6f%73%6f%66%74%2e%63%6f%6d%2f%64%6f%77%6e%6c%6f%61%64%2f%38%2f%43%2f%44%2f%38%43%44%30%31%35%42%42%2d%30%38%31%42%2d%34%39%43%35%2d%41%35%30%36%2d%39%43%39%42%35%37%30%42%38%44%44%32%2f%49%6e%73%74%61%6c%6c%65%72%44%65%74%65%63%74%69%6f%6e%2e%70%70%74%78&amp;usg=AFQjCNHXcaCOv_FFndx0mxn7eovywzKQMg">Installer Detection - Microsoft</a></li>
</ul>

<p>参考：</p>

<ul>
  <li><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/dd371711(v=vs.85).aspx">Application Manifest</a></li>
  <li><a href="https://msdn.microsoft.com/zh-cn/enus/library/bb963893.aspx">Application Compatibility: UAC: Standard User Changes</a></li>
</ul>

<h3 id="section-2">解决方案</h3>

<p><strong>问题 1：</strong></p>

<p>如下三项任选其一：</p>

<p>一、给程序改个名字，不要包含「install」、「update」和「setup」字样。</p>

<p>二、为可执行文件添加类似如下的 Manifest 文件，指定程序兼容 Win7 与 Vista（或更高版本的当前系统）。</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;</span>
  <span class="nt">&lt;assembly</span> <span class="na">xmlns=</span><span class="s">"urn:schemas-microsoft-com:asm.v1"</span> <span class="na">manifestVersion=</span><span class="s">"1.0"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;compatibility</span> <span class="na">xmlns=</span><span class="s">"urn:schemas-microsoft-com:compatibility.v1"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;application&gt;</span>
        <span class="c">&lt;!--The ID below indicates application support for Windows Vista --&gt;</span>
          <span class="nt">&lt;supportedOS</span> <span class="na">Id=</span><span class="s">"{e2011457-1546-43c5-a5fe-008deee3d3f0}"</span><span class="nt">/&gt;</span>
        <span class="c">&lt;!--The ID below indicates application support for Windows 7 --&gt;</span>
          <span class="nt">&lt;supportedOS</span> <span class="na">Id=</span><span class="s">"{35138b9a-5d96-4fbd-8e2d-a2440225f93a}"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/application&gt;</span>
    <span class="nt">&lt;/compatibility&gt;</span>
  <span class="nt">&lt;/assembly&gt;</span>
</code></pre>
</div>
<p>三、程序运行时在注册表项 <code class="highlighter-rouge">HKEY_CURRENT_USER\Software\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\Compatibility Assistant\Persisted</code> 下写入以可执行文件全路径为名，值为 REG_DWORD 类型的 1 的项。</p>

<p><strong>问题 2 和 3：</strong></p>

<p>这是 Windows Vista+ 系统对「安装包」的「特殊待遇」，如果你正在做安装包，那你应该不在乎这些；如果你正在做的不是「安装包」，那么将程序改名吧！去掉 install，去掉 update，去掉 setup，世界从此清净了。</p>

<h3 id="section-3">结论</h3>

<ol>
  <li>如果你正在做的是安装包，那么遵循 Windows Vista+ 系统对安装包的一致规范，主动要求以管理员权限执行，并在安装任务成功完成后在「添加或删除程序」里添加新的条目。</li>
  <li>如果不是在做安装包，那么将程序改名能避免 Windows Vista+ 系统的误判导致的问题。</li>
</ol>

    </article>
    <div class="share">
      <div class="share-component"></div>
    </div>
    <div class="comment">
      
  
      
      <!-- Duoshuo Comment BEGIN -->
      <!-- 多说评论框 BEGIN -->
      <div class="ds-thread" data-thread-key="/2013/05/19/when-your-exe-name-contains-install-or-setup/" data-title="可执行文件名中包含 install 或 setup" data-url="https://ztmengyuxuan.github.io/2013/05/19/when-your-exe-name-contains-install-or-setup/"></div>
      <!-- 多说评论框 END -->
      <!-- 多说公共JS代码 BEGIN (一个网页只需插入一次) -->
      <script type="text/javascript">
      var duoshuoQuery = {short_name:"abc19911991"};
        (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0]
           || document.getElementsByTagName('body')[0]).appendChild(ds);
        })();
        </script>
      <!-- 多说公共JS代码 END -->
      <!-- Duoshuo Comment END -->
      
    


    </div>
  </div>
  <div class="column one-fourth">
    
<h3>Search</h3>
<form action="get" id="site_search">
    <input type="text" id="search_box" placeholder="Search">
    <button class="btn btn-default" type="submit"><span class="octicon octicon-search"></span></button>
</form>

<ul id="search_results"></ul>

<link rel="stylesheet" type="text/css" href="/assets/css/modules/sidebar-search.css">
<script src="/assets/js/lunr.min.js"></script>
<script src="/assets/js/search.js"></script>


    
<h3>Post Directory</h3>
<div id="post-directory-module" class="mobile-hidden">
  <section class="post-directory">
  <!-- Links that trigger the jumping -->
  <!-- Added by javascript below -->
  <dl></dl>
  </section>
</div>

<script src="/assets/js/jquery.toc.js"></script>

  </div>
</div>
</section>
<!-- /section.content -->

    <footer class="container">
        <div class="site-footer" role="contentinfo">
            <div class="copyright left mobile-block">
                    © 2015
                    <span title="Liu Hua Jian">Liu Hua Jian</span>
                    <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a>
            </div>

            <ul class="site-footer-links right mobile-hidden">
                <li>
                    <a href="javascript:window.scrollTo(0,0)" >TOP</a>
                </li>
            </ul>
            <a href="git@github.com:ztmegnyuxuan/ztmengyuxuan.github.io.git" target="_blank" aria-label="view source code">
                <span class="mega-octicon octicon-mark-github" title="GitHub"></span>
            </a>
            <ul class="site-footer-links mobile-hidden">
                
                <li>
                    <a href="/" title="首页" target="">首页</a>
                </li>
                
                <li>
                    <a href="/categories/" title="分类" target="">分类</a>
                </li>
                
                <li>
                    <a href="/links/" title="链接" target="">链接</a>
                </li>
                
                <li>
                    <a href="/about/" title="关于" target="">关于</a>
                </li>
                
                <li><a href="/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li>
            </ul>
        </div>
    </footer>
    <!-- / footer -->
    <script src="/assets/vendor/s.js/dist/js/share.min.js"></script>
    <script src="/assets/js/geopattern.js"></script>
    <script src="/assets/js/prism.js"></script>
    <link rel="stylesheet" href="/assets/css/globals/prism.css">
    <script>
      jQuery(document).ready(function($) {
        // geopattern
        $('.geopattern').each(function(){
          $(this).geopattern($(this).data('pattern-id'));
        });
       // hljs.initHighlightingOnLoad();
      });
    </script>
    
</body>
</html>
